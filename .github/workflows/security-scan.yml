name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified

  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  pattern-check:
    name: Custom Pattern Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for common secret patterns
        run: |
          echo "Scanning for secret patterns..."

          PATTERNS=(
            # GitHub
            'ghp_[a-zA-Z0-9]{36}'
            'github_pat_'
            # OpenAI
            'sk-[a-zA-Z0-9]{20,}'
            # Anthropic
            'sk-ant-'
            # AWS
            'AKIA[0-9A-Z]{16}'
            # Stripe
            'sk_live_'
            'sk_test_'
            # Slack
            'xox[bpas]-'
            # Private keys
            'BEGIN.*PRIVATE KEY'
            # Generic
            'api[_-]?key.*[=:].*[a-zA-Z0-9]{20,}'
            'password.*[=:].*[^\s]{8,}'
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            # Exclude this workflow file, docs, and hook files from scanning
            MATCHES=$(grep -r -n -E -i "$pattern" --include="*.py" --include="*.js" --include="*.ts" --include="*.json" --include="*.yml" --include="*.yaml" --include="*.env*" --include="*.c" --include="*.h" . 2>/dev/null | grep -v ".github/workflows/security-scan.yml" | grep -v ".githooks/" || true)
            if [ -n "$MATCHES" ]; then
              echo "::error::Found potential secret matching pattern: $pattern"
              echo "$MATCHES"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "::error::Potential secrets detected! Review the matches above."
            exit 1
          fi

          echo "No secret patterns detected."
