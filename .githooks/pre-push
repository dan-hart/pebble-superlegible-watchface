#!/bin/bash
# Pre-push hook - second line of defense against secrets
# This catches secrets that were committed with --no-verify
#
# Install with: ./scripts/install-hooks.sh

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get the remote and URL
remote="$1"
url="$2"

echo -e "${GREEN}Running pre-push security scan...${NC}"

# Critical patterns that should NEVER be pushed
CRITICAL_PATTERNS=(
    # Service-specific (high confidence)
    'ghp_[a-zA-Z0-9]{36}'
    'sk-[a-zA-Z0-9]{20,}'
    'sk-ant-[a-zA-Z0-9-]{20,}'
    'AKIA[0-9A-Z]{16}'
    'xox[bpas]-[0-9]+-[0-9A-Za-z]+'
    'sk_live_[a-zA-Z0-9]{24,}'
    'AIza[0-9A-Za-z_-]{35}'
    '-----BEGIN[A-Z ]*PRIVATE KEY-----'
)

# Build pattern
PATTERN=""
for p in "${CRITICAL_PATTERNS[@]}"; do
    if [ -n "$PATTERN" ]; then
        PATTERN="$PATTERN|$p"
    else
        PATTERN="$p"
    fi
done

# Read stdin for refs being pushed
FOUND=0
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # Deleting a ref, skip
        continue
    fi

    # Get the range of commits being pushed
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch
        range="$local_sha"
    else
        range="$remote_sha..$local_sha"
    fi

    # Check each commit's diff for secrets
    COMMITS=$(git rev-list "$range" 2>/dev/null || echo "$local_sha")

    for commit in $COMMITS; do
        # Get the diff for this commit
        DIFF=$(git diff-tree --no-commit-id --name-only -r "$commit" 2>/dev/null || true)

        for file in $DIFF; do
            # Skip hook files
            if [[ "$file" == ".githooks/"* ]]; then
                continue
            fi

            # Check the file content at this commit
            CONTENT=$(git show "$commit:$file" 2>/dev/null || true)
            if [ -n "$CONTENT" ]; then
                MATCHES=$(echo "$CONTENT" | grep -n -E "$PATTERN" 2>/dev/null || true)
                if [ -n "$MATCHES" ]; then
                    FOUND=1
                    echo -e "${RED}Secret detected in commit $commit:${NC}"
                    echo -e "${YELLOW}File: $file${NC}"
                    echo "$MATCHES" | head -5
                    echo ""
                fi
            fi
        done
    done
done

if [ $FOUND -eq 1 ]; then
    echo -e "${RED}╔════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║  ❌ PUSH BLOCKED: Secrets detected in commits being pushed!        ║${NC}"
    echo -e "${RED}╚════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo "These secrets were likely committed using --no-verify."
    echo ""
    echo -e "${YELLOW}To fix:${NC}"
    echo "  1. Remove the secrets from the affected files"
    echo "  2. Use 'git commit --amend' to fix the last commit, or"
    echo "  3. Use 'git rebase -i' to edit earlier commits"
    echo "  4. Force push may be needed (coordinate with team)"
    echo ""
    exit 1
fi

echo -e "${GREEN}✅ No secrets detected in commits. Proceeding with push.${NC}"
exit 0
