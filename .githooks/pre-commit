#!/bin/bash
# Pre-commit hook to prevent secrets from being committed
# Install with: ./scripts/install-hooks.sh

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Patterns that indicate potential secrets
# Using word boundaries and context to reduce false positives
SECRET_PATTERNS=(
    # API keys and tokens (with assignment or quotes)
    'api[_-]?key\s*[=:]\s*["\047]?[a-zA-Z0-9]'
    'token\s*[=:]\s*["\047]?[a-zA-Z0-9]'
    'bearer\s+[a-zA-Z0-9]'
    # AWS credentials
    'AKIA[0-9A-Z]{16}'
    'aws_secret_access_key'
    'aws_access_key_id'
    # Passwords
    'password\s*[=:]\s*["\047]?[^\s]'
    'passwd\s*[=:]\s*[^\s]'
    # Private keys
    '-----BEGIN.*PRIVATE KEY-----'
    '-----BEGIN RSA PRIVATE KEY-----'
    '-----BEGIN OPENSSH PRIVATE KEY-----'
    # Database URLs with credentials
    '://[^:]+:[^@]+@'
    # Common secret patterns
    'SECRET_KEY\s*[=:]'
    'DATABASE_URL\s*[=:]'
    'PRIVATE_KEY\s*[=:]'
    # Hardcoded user paths (macOS/Linux)
    '/Users/[a-zA-Z][a-zA-Z0-9_-]+/'
    '/home/[a-zA-Z][a-zA-Z0-9_-]+/'
)

# Files to always skip (documentation, this hook itself)
SKIP_FILES=(
    'SECURITY.md'
    'CLAUDE.md'
    '.githooks/pre-commit'
    'README.md'
    '*.md'
)

# Build grep pattern
PATTERN=""
for p in "${SECRET_PATTERNS[@]}"; do
    if [ -n "$PATTERN" ]; then
        PATTERN="$PATTERN|$p"
    else
        PATTERN="$p"
    fi
done

# Get staged files (Added, Copied, Modified)
FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -z "$FILES" ]; then
    exit 0
fi

echo -e "${GREEN}Running pre-commit security scan...${NC}"

FOUND_SECRETS=0
FINDINGS=""

for FILE in $FILES; do
    # Skip if file doesn't exist
    [ -f "$FILE" ] || continue

    # Skip documentation files
    SKIP=0
    for SKIP_PATTERN in "${SKIP_FILES[@]}"; do
        if [[ "$FILE" == $SKIP_PATTERN ]]; then
            SKIP=1
            break
        fi
    done
    [ $SKIP -eq 1 ] && continue

    # Check for secrets
    MATCHES=$(grep -n -E -i "$PATTERN" "$FILE" 2>/dev/null || true)

    if [ -n "$MATCHES" ]; then
        FOUND_SECRETS=1
        FINDINGS="$FINDINGS\n${YELLOW}$FILE:${NC}\n$MATCHES\n"
    fi
done

if [ $FOUND_SECRETS -eq 1 ]; then
    echo -e "\n${RED}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║  ❌ COMMIT BLOCKED: Potential secrets detected!            ║${NC}"
    echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}\n"
    echo -e "The following files contain patterns that look like secrets:\n"
    echo -e "$FINDINGS"
    echo -e "${YELLOW}What to do:${NC}"
    echo "  1. Remove the sensitive data from the file(s)"
    echo "  2. If this is a false positive, the pattern may need adjustment"
    echo "  3. Add truly secret files to .gitignore"
    echo ""
    echo "See SECURITY.md for the repository security policy."
    echo ""
    exit 1
fi

echo -e "${GREEN}✅ No secrets detected. Proceeding with commit.${NC}"
exit 0
