#!/bin/bash
# Pre-commit hook to prevent secrets from being committed
# Install with: ./scripts/install-hooks.sh
#
# This hook scans ALL staged files for sensitive data patterns.
# It will block commits containing API keys, tokens, passwords, or private keys.

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# =============================================================================
# API KEY PATTERNS - Specific formats for known services
# =============================================================================

# GitHub tokens
# - Personal access tokens (classic): ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# - Fine-grained personal access tokens: github_pat_xxxxxxxxxxxxxxxxxxxxxxxxxx
# - OAuth access tokens: gho_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# - User-to-server tokens: ghu_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# - Server-to-server tokens: ghs_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# - Refresh tokens: ghr_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
GITHUB_PATTERNS=(
    'ghp_[a-zA-Z0-9]{36}'
    'github_pat_[a-zA-Z0-9]{22}_[a-zA-Z0-9]{59}'
    'gho_[a-zA-Z0-9]{36}'
    'ghu_[a-zA-Z0-9]{36}'
    'ghs_[a-zA-Z0-9]{36}'
    'ghr_[a-zA-Z0-9]{36}'
)

# OpenAI API keys
# - Standard: sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx (variable length)
# - Project: sk-proj-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# - Service accounts: sk-svcacct-xxxxx
# Note: OpenAI keys vary in length, so we use {20,} to catch most formats
OPENAI_PATTERNS=(
    'sk-[a-zA-Z0-9]{20,}'
    'sk-proj-[a-zA-Z0-9]{20,}'
    'sk-[a-zA-Z0-9]{20}T3BlbkFJ[a-zA-Z0-9]{20}'
    'sk-svcacct-[a-zA-Z0-9]+'
)

# Anthropic API keys
# - Format: sk-ant-xxxxx-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ANTHROPIC_PATTERNS=(
    'sk-ant-[a-zA-Z0-9-]{32,}'
    'sk-ant-api[0-9]{2}-[a-zA-Z0-9-]{32,}'
)

# Atlassian/Jira API tokens
# - API tokens are base64-like, used with email for auth
# - Also check for common env var patterns
JIRA_PATTERNS=(
    'ATLASSIAN_API_TOKEN\s*[=:]\s*["\047]?[a-zA-Z0-9]+'
    'JIRA_API_TOKEN\s*[=:]\s*["\047]?[a-zA-Z0-9]+'
    'JIRA_TOKEN\s*[=:]\s*["\047]?[a-zA-Z0-9]+'
    'CONFLUENCE_API_TOKEN\s*[=:]\s*["\047]?[a-zA-Z0-9]+'
    # Atlassian API tokens are typically 24+ chars, often with specific patterns
    'ATATT[a-zA-Z0-9]{20,}'
)

# AWS credentials
AWS_PATTERNS=(
    'AKIA[0-9A-Z]{16}'
    'ABIA[0-9A-Z]{16}'
    'ACCA[0-9A-Z]{16}'
    'AGPA[0-9A-Z]{16}'
    'AIDA[0-9A-Z]{16}'
    'AIPA[0-9A-Z]{16}'
    'AKIA[0-9A-Z]{16}'
    'ANPA[0-9A-Z]{16}'
    'ANVA[0-9A-Z]{16}'
    'APKA[0-9A-Z]{16}'
    'AROA[0-9A-Z]{16}'
    'ASCA[0-9A-Z]{16}'
    'ASIA[0-9A-Z]{16}'
    'aws_access_key_id\s*[=:]\s*["\047]?[A-Z0-9]+'
    'aws_secret_access_key\s*[=:]\s*["\047]?[a-zA-Z0-9/+]+'
)

# Slack tokens
SLACK_PATTERNS=(
    'xoxb-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}'
    'xoxp-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}'
    'xoxa-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}'
    'xoxr-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}'
    'xoxs-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}'
)

# Stripe API keys
STRIPE_PATTERNS=(
    'sk_live_[a-zA-Z0-9]{24,}'
    'sk_test_[a-zA-Z0-9]{24,}'
    'pk_live_[a-zA-Z0-9]{24,}'
    'pk_test_[a-zA-Z0-9]{24,}'
    'rk_live_[a-zA-Z0-9]{24,}'
    'rk_test_[a-zA-Z0-9]{24,}'
)

# Google API keys and service accounts
GOOGLE_PATTERNS=(
    'AIza[0-9A-Za-z_-]{35}'
    '"type"\s*:\s*"service_account"'
    'client_secret.*\.apps\.googleusercontent\.com'
)

# Discord tokens
DISCORD_PATTERNS=(
    '[MN][A-Za-z\d]{23,}\.[\w-]{6}\.[\w-]{27}'
)

# =============================================================================
# GENERIC SECRET PATTERNS
# =============================================================================

GENERIC_PATTERNS=(
    # Private keys
    '-----BEGIN[A-Z ]*PRIVATE KEY-----'
    '-----BEGIN RSA PRIVATE KEY-----'
    '-----BEGIN OPENSSH PRIVATE KEY-----'
    '-----BEGIN EC PRIVATE KEY-----'
    '-----BEGIN PGP PRIVATE KEY-----'
    '-----BEGIN DSA PRIVATE KEY-----'

    # Certificates with private keys
    '-----BEGIN ENCRYPTED PRIVATE KEY-----'

    # Generic API key assignments
    'api[_-]?key\s*[=:]\s*["\047][a-zA-Z0-9_-]{16,}["\047]'
    'apikey\s*[=:]\s*["\047][a-zA-Z0-9_-]{16,}["\047]'
    'api[_-]?secret\s*[=:]\s*["\047][a-zA-Z0-9_-]{16,}["\047]'

    # Tokens
    'access[_-]?token\s*[=:]\s*["\047][a-zA-Z0-9_-]{16,}["\047]'
    'auth[_-]?token\s*[=:]\s*["\047][a-zA-Z0-9_-]{16,}["\047]'
    'bearer\s+[a-zA-Z0-9_-]{20,}'

    # Passwords (with assignment)
    'password\s*[=:]\s*["\047][^\s"\047]{8,}["\047]'
    'passwd\s*[=:]\s*["\047][^\s"\047]{8,}["\047]'
    'pwd\s*[=:]\s*["\047][^\s"\047]{8,}["\047]'

    # Connection strings with embedded credentials
    '://[^:]+:[^@]+@[a-zA-Z0-9.-]+[:/]'

    # Common secret environment variables
    'SECRET_KEY\s*[=:]\s*["\047][a-zA-Z0-9_-]{16,}["\047]'
    'ENCRYPTION_KEY\s*[=:]\s*["\047][a-zA-Z0-9_-]{16,}["\047]'
    'SIGNING_KEY\s*[=:]\s*["\047][a-zA-Z0-9_-]{16,}["\047]'
    'JWT_SECRET\s*[=:]\s*["\047][a-zA-Z0-9_-]{16,}["\047]'
    'SESSION_SECRET\s*[=:]\s*["\047][a-zA-Z0-9_-]{16,}["\047]'

    # Database URLs
    'DATABASE_URL\s*[=:]\s*["\047][^\s"\047]+["\047]'
    'MONGO_URI\s*[=:]\s*["\047][^\s"\047]+["\047]'
    'REDIS_URL\s*[=:]\s*["\047][^\s"\047]+["\047]'

    # Hardcoded user paths (macOS/Linux)
    '/Users/[a-zA-Z][a-zA-Z0-9_-]+/'
    '/home/[a-zA-Z][a-zA-Z0-9_-]+/'
)

# =============================================================================
# BUILD COMBINED PATTERN
# =============================================================================

ALL_PATTERNS=(
    "${GITHUB_PATTERNS[@]}"
    "${OPENAI_PATTERNS[@]}"
    "${ANTHROPIC_PATTERNS[@]}"
    "${JIRA_PATTERNS[@]}"
    "${AWS_PATTERNS[@]}"
    "${SLACK_PATTERNS[@]}"
    "${STRIPE_PATTERNS[@]}"
    "${GOOGLE_PATTERNS[@]}"
    "${DISCORD_PATTERNS[@]}"
    "${GENERIC_PATTERNS[@]}"
)

# Build grep pattern string
PATTERN=""
for p in "${ALL_PATTERNS[@]}"; do
    if [ -n "$PATTERN" ]; then
        PATTERN="$PATTERN|$p"
    else
        PATTERN="$p"
    fi
done

# =============================================================================
# FILES TO SKIP
# Only skip this hook file itself to prevent false positives from pattern docs
# =============================================================================

SKIP_FILES=(
    '.githooks/pre-commit'
)

# =============================================================================
# MAIN SCANNING LOGIC
# =============================================================================

# Get staged files (Added, Copied, Modified)
FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -z "$FILES" ]; then
    exit 0
fi

echo -e "${GREEN}Running pre-commit security scan...${NC}"
echo -e "${CYAN}Checking for: GitHub, OpenAI, Anthropic, Jira, AWS, Slack, Stripe, Google tokens${NC}"

FOUND_SECRETS=0
FINDINGS=""

for FILE in $FILES; do
    # Skip if file doesn't exist
    [ -f "$FILE" ] || continue

    # Skip binary files
    if file "$FILE" | grep -q "binary"; then
        continue
    fi

    # Skip specific files (only the hook itself)
    SKIP=0
    for SKIP_PATTERN in "${SKIP_FILES[@]}"; do
        if [[ "$FILE" == "$SKIP_PATTERN" ]]; then
            SKIP=1
            break
        fi
    done
    [ $SKIP -eq 1 ] && continue

    # Check for secrets
    MATCHES=$(grep -n -E "$PATTERN" "$FILE" 2>/dev/null || true)

    if [ -n "$MATCHES" ]; then
        FOUND_SECRETS=1
        FINDINGS="$FINDINGS\n${YELLOW}$FILE:${NC}\n$MATCHES\n"
    fi
done

# =============================================================================
# OUTPUT RESULTS
# =============================================================================

if [ $FOUND_SECRETS -eq 1 ]; then
    echo -e "\n${RED}╔════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║  ❌ COMMIT BLOCKED: Potential secrets/sensitive data detected!     ║${NC}"
    echo -e "${RED}╚════════════════════════════════════════════════════════════════════╝${NC}\n"
    echo -e "The following files contain patterns that look like secrets:\n"
    echo -e "$FINDINGS"
    echo -e "${YELLOW}Detected pattern types:${NC}"
    echo "  • GitHub tokens (ghp_, github_pat_, gho_, ghu_, ghs_, ghr_)"
    echo "  • OpenAI API keys (sk-...)"
    echo "  • Anthropic API keys (sk-ant-...)"
    echo "  • Jira/Atlassian tokens"
    echo "  • AWS credentials (AKIA...)"
    echo "  • Slack tokens (xoxb-, xoxp-)"
    echo "  • Stripe keys (sk_live_, sk_test_)"
    echo "  • Google API keys"
    echo "  • Private keys (-----BEGIN...PRIVATE KEY-----)"
    echo "  • Generic passwords, tokens, connection strings"
    echo "  • Hardcoded user paths"
    echo ""
    echo -e "${YELLOW}What to do:${NC}"
    echo "  1. Remove the sensitive data from the file(s)"
    echo "  2. Use environment variables instead of hardcoding"
    echo "  3. Add files with real secrets to .gitignore"
    echo "  4. If this is a FALSE POSITIVE in documentation, you may need to"
    echo "     obfuscate the example (e.g., sk-xxxx... instead of real format)"
    echo ""
    echo "See SECURITY.md for the repository security policy."
    echo ""
    exit 1
fi

echo -e "${GREEN}✅ No secrets detected. Proceeding with commit.${NC}"
exit 0
